---
title: "Principles of Visualization"
format:
  html:
    sidebar: true
    grid:
      sidebar-width: 420px
---

<div id="tutor-root" data-chapter="3_principles_of_visualization" class="tutor-floating"></div>
<script src="../assets/tutor-chat.js"></script>
<link rel="stylesheet" href="../assets/tutor-chat.css">


## Preparation for Class

- Watch the lecture recording

- Do any required reading (see below)

- Ask Dr. Lysenko any questions you have

- Pass Dr. Lysenko's quiz

## Lecture Recording and Slides

```{=html}
<div class="yt-embed">
  <div class="ratio">
    <iframe
      src="https://www.youtube.com/embed/NpxhDxk9gkA"
      title="Lecture video"
      frameborder="0"
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
      allowfullscreen>
    </iframe>
  </div>
</div>
```

```{=html}
<div style="width: 100%; height: 800px; margin-top: 1.5em;">
  <iframe
    src="../lecture_slides/3_principles_of_visualization/3_principles_of_visualization.pdf"
    style="width: 100%; height: 100%; border: 1px solid #ccc;"
    title="Lecture slides">
  </iframe>
</div>
```

## Required Reading

## Suggested Reading

[Fundamentals of Data Visualization: Chapters 1, 2, 3, and 4](https://clauswilke.com/dataviz/)

## In-class Exercises

[Download the exercises](../exercises/3_principles_of_visualization/3_principles_of_visualization_exercises.Rmd)

[Download the data for the exercises](../exercises/3_principles_of_visualization/data1.csv)

::: {.callout-tip collapse="true"}

### Expand to see the answers

```{webr}
# Packages
library(tidyverse)

### 1
# Read in data
url <- "https://jmc108.github.io/hugen2073-textbook/exercises/3_principles_of_visualization/data1.csv"
data1 <- read.csv(url)

# Make a plot of v3 and v4
# The point is not to let a specific hypothesis blind you to important patterns
data1 %>% 
  ggplot() +
  geom_point(aes(x=v3, y=v4))

### 2
# Make the same scatterplot, but drop almost all the terrible parameters and redundancies
# Try to make a title that draws attention to an interesting feature
p_better <- ggplot(mpg, aes(displ, hwy)) +
  geom_point(
    aes(color = class)) +
  geom_smooth(
    method = "loess") +
  xlab("Engine size (L)") +
  ylab("Highway mpg") +
  ggtitle("Do two-seaters break the trend?")

p_better

### 3
# Simulate data
set.seed(2)

features <- paste0("Feature ", sprintf("%02d", 1:12))
positions <- seq(-1000, 1000, by = 10)

df <- expand.grid(
  feature = factor(features, levels = features, ordered = TRUE),
  pos   = positions
) %>%
  mutate(
    g = as.integer(feature),

    # Make groups VERY similar
    peak_height = 4 + rnorm(length(features), 0, 0.3)[g],  # small differences
    peak_sd     = 260 + rnorm(length(features), 0, 15)[g], # similar width

    # Shared structure + noise → overlap
    signal = peak_height * exp(-(pos^2) / (2 * peak_sd^2)) +
             rnorm(n(), sd = 1.3)
  )

# Background data: replicate ALL lines into ALL panels
df_bg <- df %>%
  tidyr::crossing(panel = levels(df$feature))   # every row repeated for every facet
head(df_bg)

# Foreground data: only the focal group's line in its own panel
df_fg <- df %>%
  mutate(panel = feature)

# Now plot
ggplot() +
  # background: all groups in every panel (gray)
  geom_line(
    data = df_bg,
    aes(x = pos, y = signal, group = feature),
    color = "black",
    alpha = 0.5,
    linewidth=0.1
  ) +
  # foreground: highlight the panel's group (colored)
  geom_line(
    data = df_fg,
    aes(x = pos, y = signal, group = feature, color = feature),
    linewidth = 0.5
  ) +
  facet_wrap(~ panel) +
  labs(x = "pos", y = "signal")

### 4
library("RColorBrewer")

##  First task (colors for a few groups)
data.frame(
  group = c("A", "B", "C", "D"),
  value = c(18, 35, 22, 29)
) %>%
  ggplot(aes(x = group, y = value, fill=group)) +
  geom_col() +
  scale_fill_brewer(palette="Set3")

##  Second task
# Simulate data
set.seed(1)

af_bins <- c(
  "<0.1%",
  "0.1–0.5%",
  "0.5–1%",
  "1–5%",
  "5–10%",
  ">10%"
)

severity <- c(
  "Synonymous",
  "Missense (benign)",
  "Missense (damaging)",
  "Splice site",
  "Stop gained"
)

df <- expand.grid(
  af_bin = factor(af_bins, levels = af_bins, ordered = TRUE),
  consequence = factor(severity, levels = severity, ordered = TRUE)
)

# rare variants are more likely to be severe
base <- exp(seq(log(5000), log(300), length.out = length(af_bins)))

df$n_variants <- round(
  base[as.integer(df$af_bin)] *
    rev(seq(1.0, 0.4, length.out = length(severity)))[as.integer(df$consequence)] *
    runif(nrow(df), 0.7, 1.3)
)
df$af_bin <- as.character(df$af_bin)

# Helper variable for you!
af_bins <- c(
  "<0.1%",
  "0.1–0.5%",
  "0.5–1%",
  "1–5%",
  "5–10%",
  ">10%"
)

# Suggested code for getting the color mapped correctly
# and putting the bins in the right order
# and avoiding bright, white-ish colors that are hard to see
colors <- brewer.pal(9, "Blues")[4:9]
df %>% 
  mutate(af_bin = factor(af_bin, levels = af_bins)) %>% 
   ggplot(.,
       aes(x = consequence,
           y = n_variants,
           fill = af_bin)) +
  geom_col(position="dodge") + 
 scale_fill_manual(limits=af_bins, values=colors)

## Third task - sequential palettes with many colors
# Many AF bins between 0 and 0.5
af_bins <- sprintf(
  "%.3f–%.3f",
  seq(0, 0.475, by = 0.025),
  seq(0.025, 0.5, by = 0.025)
)
severity <- c(
  "Synonymous",
  "Missense (benign)",
  "Missense (damaging)",
  "Splice site",
  "Stop gained"
)
set.seed(1)

df <- expand.grid(
  af_bin = af_bins,
  consequence = severity
)

# Make AF bins ordered *for plotting*
df$af_bin <- factor(df$af_bin, levels = af_bins)

# Baseline: rarer variants are more numerous
base <- exp(seq(log(6000), log(800), length.out = length(af_bins)))

df$n_variants <- round(
  base[as.integer(df$af_bin)] *
    rev(seq(1.0, 0.4, length.out = length(severity)))[
      match(df$consequence, severity)
    ] *
    runif(nrow(df), 0.8, 1.2)
)

# Plot
# Use length(af_bins) to get the number of categories
# Noticed that we've started in the darker part of the blues spectrum by using [4:8]
cols <- colorRampPalette(
  RColorBrewer::brewer.pal(9, "Blues")[4:8]
)(length(af_bins))

df %>%
  ggplot(aes(
    x = consequence,
    y = n_variants,
    fill = af_bin
  )) +
  geom_col(position = "dodge") +
  scale_fill_manual(
    values = cols,
    limits = af_bins
  )

# Or use hex codes of your choice
cols <- colorRampPalette(c("#C6E084", "#557A01"))(length(af_bins))
df %>%
  ggplot(aes(
    x = consequence,
    y = n_variants,
    fill = af_bin
  )) +
  geom_col(position = "dodge") +
  scale_fill_manual(
    values = cols,
    limits = af_bins
  )

## Diverging color palette
# Simulate data
set.seed(1)
df <- expand.grid(
  gene   = paste0("G", 1:25),
  sample = paste0("S", 1:8)
)
df$logFC <- rnorm(nrow(df), mean = 0, sd = 1)

# You can use different colors, but you should keep mid="white"
ggplot(df, aes(sample, gene, fill = logFC)) +
  geom_tile() +
  scale_fill_gradient2(low = "blue", high = "red", mid="white")

### 5
# Simulate data
set.seed(5)
n_genes <- 2000
df <- data.frame(
  expression = c(
    # Condition A
    c(
      rep(0, 1200),                     # many unexpressed genes
      rgamma(800, shape = 1.2, scale = 2)
    ),
    # Condition B
    c(
      rep(0, 900),
      rgamma(1100, shape = 1.4, scale = 2.5)
    )
  ),
  condition = rep(c("Treatment", "Control"), each = n_genes)
)
# Use position="dodge"
ggplot(df, aes(x = expression, fill = condition)) +
  geom_histogram(position="dodge") +
  scale_x_continuous(
    name = "Gene expression (counts)",
    expand = c(0, 0)
  ) +
  theme_minimal()

### 6
# Simulate data
n <- 120
t <- 1:n

df <- data.frame(
  month = seq.Date(as.Date("2015-01-01"), by = "month", length.out = n)
)

# Exposure: smooth upward drift + mild seasonality
df$exposure <- 40 + 0.03*t + 1.2*sin(2*pi*t/12)

# True relationship: cases depend on exposure from 3 months ago + own seasonality
lag_k <- 3
expo_lag <- c(rep(NA, lag_k), df$exposure[1:(n - lag_k)])

df$cases <- 55 + 4.0*(expo_lag - mean(df$exposure, na.rm = TRUE)) +
  6*sin(2*pi*(t + 2)/12)

# drop first lagged months (or keep them as NA)
df <- df[!is.na(df$cases), ]


df_long <- pivot_longer(df, c(exposure, cases), names_to = "series", values_to = "value")

# Plot
ggplot(df_long, aes(month, value)) +
  geom_line(linewidth = 1) +
  facet_wrap(~ series, ncol = 1, scales = "free_y") +
  theme_minimal()

# Lie
# ---- STUDENT CONTROLS ----
cases_ylim <- c(0, 1000)        # tighten to reveal, widen to hide
expo_ylim  <- c(30, 45)        # tighten to exaggerate, widen to flatten
# --------------------------

a <- diff(cases_ylim) / diff(expo_ylim)
b <- cases_ylim[1] - a * expo_ylim[1]

ggplot(df, aes(month)) +
  geom_line(aes(y = cases), linewidth = 1) +
  geom_line(aes(y = a * exposure + b), linewidth = 1, linetype = 2) +
  coord_cartesian(ylim = cases_ylim) +
  scale_y_continuous(
    name = "Cases",
    sec.axis = sec_axis(~ (. - b) / a, name = "Exposure level")
  ) +
  theme_minimal()


### 7
# See .Rmd
```

:::






